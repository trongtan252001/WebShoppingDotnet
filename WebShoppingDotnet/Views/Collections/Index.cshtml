@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = ViewBag.title;

}
<link rel="stylesheet" href="~/css/search.css">
<link rel="stylesheet" href="~/assets/modal/modal.css">

<section id="main-search" class="margin-top-mobile">
    <div class="container">
        <div class="contain">
            <div class="left-contain">
                <div class="left-contain-price-range">
                    <p class="left-contain-item-title">Khoảng Giá</p>
                    <form name="myForm" class="left-contain-item-box-content">
                        
                        <label><input type="radio" name="all" value="0"> Tất Cả</label><br>
                        <label><input type="radio" name="all" value="0-300000"> Nhỏ hơn 300,000₫</label><br>
                        <label><input type="radio" name="all" value="300000-500000">Từ 300,000₫ - 500,000₫</label><br>
                        <label><input type="radio" name="all" value="500000-700000"> Từ 500,000₫ - 700,000₫</label><br>
                        <label><input type="radio" name="all" value="700000-1000000"> Từ 700,000₫ - 1,000,000₫</label><br>
                        <label><input type="radio" name="all" value="1000000-1500000"> Từ 1,000,000₫ - 1,500,000₫</label><br>
                        <label><input type="radio" name="all" value="1500000"> Lớn hơn 1,500,000₫</label><br>
                    </form>
                </div>
                <div class="left-contain-size">
                    <p class="left-contain-item-title">Kích Thước</p>
                    <div class="left-contain-item-box-content-size">
                        <div class="left-contain-item-box-content-size-item">
                            <input class="size-product" type="radio" name="size" value="S">
                            <label>S</label><br>
                        </div>
                        <div class="left-contain-item-box-content-size-item">
                            <input class="size-product" type="radio" name="size" value="M">
                            <label>M</label><br>
                        </div>
                        <div class="left-contain-item-box-content-size-item">
                            <input class="size-product" type="radio" name="size" value="L">
                            <label>L</label><br>
                        </div>
                        <div class="left-contain-item-box-content-size-item">
                            <input class="size-product" type="radio" name="size" value="XL">
                            <label>XL</label><br>
                        </div>
                    </div>
                </div>
                
            </div>

            <div class="right-contain">
                <div class="top-search-title">
                    <div class="wrapper-search-left">
                        <h2 class="text-search">
                            @ViewBag.title
                        </h2>
                        <span class="title-sum-product">@ViewData["TotalItems"] sản phẩm</span>

                    </div>

                   
                    <div class="right-contain-sort">
                        <label for="cars">Sắp Xếp</label>
                        <a asp-action="Index" asp-route-sortOrder="@ViewData["NameSortParm"]">Last Name</a>
                        <select name="cars" id="cars">
                            <option value="all">Tùy chọn</option>
                            <option value="name">
                                Sắp xếp từ A-Z
                            </option>
                            <option value="name_desc">Sắp xếp từ Z-A</option>
                            <option value="price">Sắp xếp theo giá tăng dần</option>
                            <option value="price_desc">Sắp xếp theo giá giảm dần</option>
                        </select>
                    </div>
                </div>
                <div class="list-tab-content">
                    @foreach (Product product in Model)
                    {
                        @await Html.PartialAsync("Components/ViewProduct/Index", product)
                    }

                </div>

                @{
                    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
                    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
                    var left = (Model.PageIndex - 3) >= 1 ? Model.PageIndex - 3 : 1;
                    var right = (Model.PageIndex + 3) <= Model.TotalPages ? Model.PageIndex + 3 : Model.TotalPages;

                }

                <div class="pagination">
                    <a asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@(Model.PageIndex - 1)"
                       asp-route-size="@ViewData["size"]"
                       asp-route-rangePrice="@ViewData["rangePrice"]"
                       class="@prevDisabled"
                       id="per-page">
                        &laquo;
                    </a>
                    <div class="page-parrent">


                        @for (var i = left; i <= right; i++)
                        {
                            if (i == Model.PageIndex)
                            {
                                <a asp-action="Index"
                                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                                   asp-route-size="@ViewData["size"]"
                                   asp-route-rangePrice="@ViewData["rangePrice"]"
                                   asp-route-pageNumber="@i"

                                   id="per-page" class="page active">
                                    @i
                                </a>


                            }
                            else
                            {
                                <a asp-action="Index"
                                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                                   asp-route-size="@ViewData["size"]"
                                   asp-route-rangePrice="@ViewData["rangePrice"]"
                                   asp-route-pageNumber="@i"

                                   id="per-page" class="page">
                                    @i
                                </a>
                            }

                        }
                    </div>

                    <a asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-size="@ViewData["size"]"
                       asp-route-rangePrice="@ViewData["rangePrice"]"
                       asp-route-pageNumber="@(Model.PageIndex + 1)"

                       class="@nextDisabled" id="next-page">&raquo;</a>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="modal-custom" id="modal-cart">
    <div class="modal-dialog-custom">
        <div class="modal-content-custom">
            <div class="modal-slide">
                <img class="modal-img" src="" alt="">

            </div>
            <div class="modal-body-custom">
                <h4 class="modal-title">
                   
                </h4>
                <h4 class="modal-id">
                    
                </h4>
                <div class="modal-price">
                    <span class="slide-collection-price">
                        
                    </span>
                    <span class="current-price">
                        
                    </span>
                </div>
                <p class="color-product modal-text"><span class="modal-text-bold">Màu sắc:</span><span class="product-color">trắng</span></p>
                <div class="product-size modal-text">
                    <p class="modal-text-bold">Kích cỡ:</p>
                    <ul class="product-list-sizes">
                        <li class="product-list-size">S</li>
                        <li class="product-list-size">M</li>
                        <li class="product-list-size">L</li>
                        <li class="product-list-size">XL</li>
                    </ul>
                </div>
                <a class="btn-modal">THÊM VÀO GIỎ HÀNG</a>
                <a href="#" class="link-continue">Xem chi tiết đầy đủ</a>
            </div>
            <div class="icon-close-modal" onclick="closeModal()">
                <i class="fa-solid fa-xmark icon-modal"></i>
            </div>
        </div>

    </div>
</div>
@section Scripts
{
    <script>
        var pageNumber =@ViewData["pageNumber"];
        var demo1 = false;
        var sortSelect = document.getElementById("cars");
        var sortName = "@ViewData["CurrentSort"]";
        var size = "@ViewData["size"]";

        sortSelect.value = sortName;
        var rangePrice = "@ViewData["rangePrice"]";
        if (rangePrice) {
            document.querySelector(`input[value="${rangePrice}"]`).checked = true;
        }
        sortSelect.addEventListener("change",
            e => {
                window.location.replace("?sortOrder=" + sortSelect.value
                    +"&rangePrice="+rangePrice
                    +"&size="+size
                    +"&pageNumber="+1
                );
            });
        var rad = document.myForm.all;
        var prev = null;
        for (var i = 0; i < rad.length; i++) {
            rad[i].addEventListener('change',
                function() {
                    if (this !== prev) {
                        prev = this;
                    }
                    if (!demo1) {
                        window.location.replace("?sortOrder=" + sortName
                            +"&rangePrice="+ this.value
                            +"&size="+size
                            +"&pageNumber="+1
                        );
                    } else {
                        demo1 = true;
                    }

                });
        }
        var rad2 = document.querySelectorAll("input[name=size]");
        var prev2 = null;
        var demo2 = false;
        if (size) {
            document.querySelector(`input[value="${size}"]`).checked = true;
        }
        for (var i = 0; i < rad2.length; i++) {
            rad2[i].addEventListener('change',
                function() {
                    if (this !== prev2) {
                        prev2 = this;
                    }
                    if (!demo1) {
                        window.location.replace("?sortOrder=" + sortName
                            +"&rangePrice="+ rangePrice
                            +"&size="+this.value
                            +"&pageNumber="+1
                        );
                    } else {
                        demo2 = true;
                    }

                });
        }

    </script>

    <script src="~/script/search.js"></script>
     <script>
        function pushNotify(status, message, title) {
            new Notify({
                status: status,
                title: title,
                text: message,
                effect: 'fade',
                speed: 300,
                customClass: '',
                customIcon: '',
                showIcon: true,
                showCloseButton: true,
                autoclose: true,
                autotimeout: 2000,
                gap: 20,
                distance: 20,
                type: 1,
                position: 'right top',
                customWrapper: '',
            })
        }
        function openModal(element) {

            $('.product-list-sizes .product-list-size').removeClass('crossed');
            $('.product-list-sizes .product-list-size').removeClass('active');


            var id =element.getAttribute('data-product-id');
            var name =element.getAttribute('data-product-name');
            var price =element.getAttribute('data-product-price');
            var img =element.getAttribute('data-product-img');
            var sell =element.getAttribute('data-product-sell');
            var sizeS =element.getAttribute('data-product-size-s');
            var sizeL =element.getAttribute('data-product-size-l');
            var sizeM =element.getAttribute('data-product-size-m');
            var sizeXL =element.getAttribute('data-product-size-xl');
            var color =element.getAttribute('data-product-color');
            // alert(sizeS+" "+sizeM+" "+sizeL+" "+sizeXL);

            var listbtnSize = document.getElementsByClassName('product-list-size');
            if(parseInt(sizeS) <= 0) {
                listbtnSize[0].classList.add('crossed');


            }
            if(parseInt(sizeM) <= 0) {
                listbtnSize[1].classList.add('crossed');
            }
            if(parseInt(sizeL) <= 0) {
                listbtnSize[2].classList.add('crossed');
            }
            if(parseInt(sizeXL) <= 0) {
                listbtnSize[3].classList.add('crossed');
            }




            $('.modal-img').attr('src',img);
            $('.modal-title').text(name);
            $('.modal-id').text(id);
            if(sell > 0){
                $('.modal-custom .slide-collection-price').text(formatNumber(price-sell*price)+'đ');
                $('.modal-custom .current-price').text(formatNumber(price)+'đ');
            }else{
                $('.modal-custom .slide-collection-price').text(formatNumber(price)+'đ');
                $('.modal-custom .current-price').text('');
            }
            $('.product-color').text(color);
            modalCart.style.display = "flex";
        }
        function formatNumber(num) {
            //convert double to int
            num =parseInt(num);
            return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.')
        }
        

        //modal close dom
        const modalCart = document.getElementById('modal-cart');
        function closeModal() {
            modalCart.style.display = "none";
        }
        window.onload = function () {
            const modalCart = document.getElementById('modal-cart');
            function closeModal() {
                modalCart.style.display = "none";
            }
            function openModal(position) {
                modalCart.style.display = "flex";

            }
            //modal close over modal
            //modal close on click outside
            modalCart.addEventListener('click', function (event) {
                if (event.target === modalCart) {
                    modalCart.style.display = "none";
                }
            });
            //windowns load dom
            document.querySelectorAll('.product-list-size').forEach(element => {
                element.addEventListener('click', function () {
                    element.classList.toggle('active');
                });
            });
        }
        
        $('.btn-modal').click(function () {
            var sizes = document.getElementsByClassName('product-list-size');
            //get class active
            var arrSize = [];
            for (var i = 0; i < sizes.length; i++) {
                if (sizes[i].classList.contains('active') && sizes[i].classList.contains('crossed') == false) {
                    var size = sizes[i].innerText;
                    arrSize.push(size);
                }
            }
            if(arrSize.length == 0){
                pushNotify('warning','Vui lòng chọn size','chọn size');
                return;
            }
            addCart( arrSize);

        });
        function addCart(arrSize) {
            var id = $('.modal-id').text();
            closeModal();
            //convert array to json
            var size = JSON.stringify(arrSize);
            //ajax
            $.ajax({
                url: '@Url.Action("AddCart","Cart")',
                type: 'POST',
                data: {
                    id: id,
                    size: size
                },
                success: function (json) {
                    //get json
                    if (json.success === true) {
                        $('.cart-count.color-red').text(json.quantity);
                        pushNotify('success','thêm vào giỏi hàng thành công','Thêm Sản phẩm');

                    } 
                    else {
                        if (json.isRedirect) {
                            window.location.href = json.redirectUrl;
                        } else {
                            pushNotify('error','thêm vào giỏi hàng thất bại','Thêm Sản phẩm');

                        }


                    }
                }
            });

        }
    </script>
}